var WebPDA_Debug=!1,WebPDA_Util={};
function WebPDA(h,b,d){function c(a,q){for(var b in k)if(null!=k[b]&&void 0!=k[b]&&q(a,k[b].parameterObj))return k[b];return null}function e(a,q){this.myPVs=[];this.webPDA=q;this.id=a;this.value=null;this.bufferAllValues=!1;this.allBufferedValues=[];this.isPaused=this.writeAllowed=this.connected=!1;this.parameterObj=null}function f(a){this.name=a||"";this.id=-1;this.internalPV=null;this.pvCallbacks=[];this.paused=!1}var r=0,p=0,n=[],k=[],g=null,l=this,m=[],s=[],t=[],u=[];this.isLive=!1;(function(a){if(null!=
g)throw Error("Please close current websocket before opening a new one.");if("WebSocket"in window)g=new WebSocket(a,"org.webpda");else if("MozWebSocket"in window)g=new MozWebSocket(a,"org.webpda");else throw Error("WebSocket is not supported by this browser.");g.binaryType="arraybuffer";g.onopen=function(a){l.login(b,d);l.isLive=!0;for(var c in m)m[c](a)};g.onmessage=function(a){var b;if("string"==typeof a.data)b=JSON.parse(a.data),WebPDA_Debug&&console.log("received: "+a.data);else{b=a.data;var c=
{},d=new Int32Array(b);0==d[0]?c.e="val":1==d[0]&&(c.e="bufVal");c.pv=d[1];c.d=b;b=c;WebPDA_Debug&&console.log("received: "+a.data+" "+a.data.byteLength)}a=b;if(null!=a.msg){"Ping"==a.msg?(b=JSON.stringify({commandName:"Pong",count:a.Count}),l.sendText(b)):"Error"==a.msg?console.log("Error: "+a.title+" - "+a.details):WebPDA_Debug&&console.log(a);for(var e in u)u[e](a)}null!=a.pv&&null!=k[a.pv]&&k[a.pv].firePVEventFunc(a)};g.onclose=function(b){this.isLive=!1;WebPDA_Debug&&console.log("websocket closed:"+
a);for(var c in n)n[c].firePVEventFunc({pv:c,e:"conn",d:!1});for(var d in k)k[d].firePVEventFunc({pv:k[d].id,e:"conn",d:!1});for(d in s)s[d](b)};g.onerror=function(a){for(var b in t)t[b](a)}})(h);this.addWebSocketOnOpenCallback=function(a){m.push(a)};this.removeWebSocketOnOpenCallback=function(a){m.splice(m.indexOf(a),1)};this.addWebSocketOnCloseCallback=function(a){s.push(a)};this.addWebSocketOnErrorCallback=function(a){t.push(a)};this.addOnServerMessageCallback=function(a){u.push(a)};this.setPVValueById=
function(a,b){null!=n[a]&&this.setPVValue(n[a],b)};this.setPVValue=function(a,b){var c=JSON.stringify({commandName:"SetPVValue",id:a.internalPV.id,value:b});this.sendText(c)};this.setServerBufferSize=function(a){a=JSON.stringify({commandName:"SetServerBufferSize",size:a});this.sendText(a)};this.close=function(){null!=g&&g.close();g=null};this.login=function(a,b){var c=JSON.stringify({commandName:"Login",username:a,password:b});this.sendText(c)};this.logout=function(){var a=JSON.stringify({commandName:"Logout"});
this.sendText(a)};this.getAllPVs=function(){return n};this.getPV=function(a){return n[a]};this.sendText=function(a){WebPDA_Debug&&console.log("sending "+a);g.send(a)};this.internalCreatePV=function(a,b,d,g){d=c(b,d);if(null==d){d=new e(p,this);d.parameterObj=b;k[p]=d;var l=JSON.stringify(WebPDA_Util.extend({commandName:"CreatePV",id:p},b));if(this.isLive)this.sendText(l);else{var m=this,h=null,h=function(a){m.sendText(l);setTimeout(function(){m.removeWebSocketOnOpenCallback(h)},0)};this.addWebSocketOnOpenCallback(h)}p++}a=
new f(a);a.internalPV=d;d.addPV(a);a.bufferAllValues=g;n[r]=a;a.id=r;r++;return a};e.prototype.firePVEventFunc=function(a){this.webPDA.processJsonForPV(this,a);for(var b in this.myPVs)this.myPVs[b].firePVEventFunc(a)};e.prototype.addPV=function(a){this.myPVs.push(a)};e.prototype.closePV=function(a){delete this.webPDA.getAllPVs()[a.id];for(var b in this.myPVs)if(this.myPVs[b].id==a.id){this.myPVs.splice(b,1);break}0<this.myPVs.length||(a=this.id,b=JSON.stringify({commandName:"ClosePV",id:a}),l.sendText(b),
delete k[a])};e.prototype.pausePV=function(a){a=!0;for(var b in this.myPVs)if(!this.myPVs[b].isPaused()){a=!1;break}a!=this.isPaused&&(b=JSON.stringify({commandName:"PausePV",id:this.id,paused:a}),l.sendText(b));this.isPaused=a};f.prototype.isConnected=function(){return this.internalPV.connected};f.prototype.isBufferingAllValues=function(){return this.internalPV.bufferAllValues};f.prototype.isWriteAllowed=function(){return this.internalPV.writeAllowed};f.prototype.isPaused=function(){return this.paused};
f.prototype.getValue=function(){return this.internalPV.value};f.prototype.getAllBufferedValues=function(){return this.internalPV.allBufferedValues};f.prototype.firePVEventFunc=function(a){if(!this.paused)for(var b in this.pvCallbacks)this.pvCallbacks[b](a.e,this,a.d)};f.prototype.addCallback=function(a){this.pvCallbacks.push(a)};f.prototype.removeCallback=function(a){for(var b in this.pvCallbacks)this.pvCallbacks[b]==a&&delete this.pvCallbacks[b]};f.prototype.setValue=function(a){setPVValue(this,
a)};f.prototype.setPaused=function(a){this.paused=a;this.internalPV.pausePV(this)};f.prototype.close=function(){this.internalPV.closePV(this)}}
(function(){function h(b){var d={},c;for(c in b)d[c]="object"==typeof b[c]&&null!=b[c]?h(b[c]):b[c];return d}WebPDA_Util={extend:function(b,d){b||(b={});for(var c in d)b[c]=d[c];return b},clone:h,formatDate:function(b){function d(b){return 10>b?"0"+b:b}return b.getFullYear()+"-"+d(b.getMonth()+1)+"-"+d(b.getDate())+" "+d(b.getHours())+":"+d(b.getMinutes())+":"+d(b.getSeconds())},sliceArrayBuffer:function(b,d,c){0>c&&(c=b.byteLength);var e=new ArrayBuffer(c-d);b=new Int8Array(b);for(var f=new Int8Array(e),
h=d;h<c;h++)f[h-d]=b[h];return e},decodeUTF8Array:function(b){var d="",c=0,e=c1=c2=0;for(3<=b.length&&239==(b[0]&239)&&187==(b[1]&187)&&191==(b[2]&191)&&(c=3);c<b.length;)if(e=b[c]&255,128>e)d+=String.fromCharCode(e),c++;else if(191<e&&224>e){if(c+1>=b.length)throw"Un-expected encoding error, UTF-8 stream truncated, or incorrect";c2=b[c+1]&255;d+=String.fromCharCode((e&31)<<6|c2&63);c+=2}else{if(c+2>=b.length||c+1>=b.length)throw"Un-expected encoding error, UTF-8 stream truncated, or incorrect";c2=
b[c+1]&255;c3=b[c+2]&255;d+=String.fromCharCode((e&15)<<12|(c2&63)<<6|c3&63);c+=3}return d}}})();